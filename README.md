# Tradex API

This project contains a simple FastAPI backend for a crypto and stock trading bot. It provides JWT-based authentication, CRUD endpoints for trades stored in a Supabase database, and a Redis cache for market data.

## Setup

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```
   Whenever `requirements.txt` is updated, re-run the command above to reinstall
   the dependencies. The file pins `numpy<2.0` for compatibility and includes
   basic indicator helpers so no external `pandas-ta` package is required.
2. Create a project in [Supabase](https://supabase.com) and create the following tables:
   - `users` and `trades` matching the models in `app/schemas.py` (be sure the `users` table includes a `total_profit` numeric column with a default of `0`).
   - `user_settings` using the SQL below.
3. Grab your project API URL and service role key from the Supabase dashboard and set them as environment variables:
   ```bash
   export SUPABASE_URL=https://<project-id>.supabase.co
   export SUPABASE_KEY=<your-service-role-key>
   export REDIS_URL=redis://localhost:6379/0  # optional
   export ENCRYPTION_KEY=<32-byte-base64-key>
   ```
   A local Redis server must be running for caching to work. If `REDIS_URL` is empty or the server is unavailable, the API will run without caching the market data.
4. Run the application:
   ```bash
   uvicorn app.main:app --reload
   ```

When a strategy is started it will place real market orders on Binance using the
API keys configured for the user. Ensure the keys have trading permissions and
exercise caution as real funds are at risk.

The API documentation is available at `/docs` when the server is running.

## Supabase SQL

Run the following SQL in Supabase to create the `user_settings` table:

```sql
create table if not exists user_settings (
  id bigint generated by default as identity primary key,
  user_id bigint not null references users(id) unique,
  binance_api_key text not null,
  binance_api_secret text not null
);
```

Additionally create a table to track running strategies per user:

```sql
create table if not exists user_strategy_runs (
  id bigint generated by default as identity primary key,
  user_id bigint not null references users(id),
  strategy_id text not null,
  started_at timestamp with time zone default now(),
  stopped_at timestamp with time zone,
  is_running boolean default true
);

create unique index if not exists user_strategy_active_idx
  on user_strategy_runs(user_id, strategy_id)
  where is_running is true;
```

To store the cumulative profit for each user, add a `total_profit` column to the `users` table:

```sql
alter table users add column if not exists total_profit numeric default 0;
```
